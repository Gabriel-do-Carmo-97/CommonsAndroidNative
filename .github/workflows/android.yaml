name: Android Publish Lib Design System

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build_Test_and_Publish:
    name: Build, Test and Publish
    runs-on: ubuntu-latest

    # Permiss√µes para que a Action possa escrever pacotes no GitHub Packages e criar tags/releases
    permissions:
      contents: write
      packages: write

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4 # Vers√£o atualizada
        with:
          # fetch-depth: 0 √© necess√°rio para que a action de detec√ß√£o de mudan√ßas possa comparar o hist√≥rico completo
          fetch-depth: 0
          lfs: true

      - name: üîé Detect changed modules
        id: changed_modules
        uses: tj-actions/changed-files@v44 # Vers√£o atualizada
        with:
          # Adicione todos os m√≥dulos que podem ser publicados
          files: |
            maps/**
            message/**
            payment/**
            authentication/**

      - name:  granting permission to gradlew
        run: chmod +x gradlew

      - name: ‚òïÔ∏è Set up JDK 17
        uses: actions/setup-java@v4 # Vers√£o atualizada
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3

      # =================================================================
      # PASSO √öNICO E CORRIGIDO PARA BUILD E PUBLISH
      # Aqui, definimos as credenciais uma vez e executamos todos os comandos Gradle.
      # =================================================================
      - name: üöÄ Build and Publish changed modules
        # Fornece as credenciais corretas para TODAS as tarefas Gradle abaixo
        env:
          GPR_USER: ${{ secrets.GPR_USER }}
          GPR_KEY: ${{ secrets.GPR_KEY }}
        run: |
          # 1. Build do projeto inteiro (l√™ depend√™ncias e compila)
          echo "Building the entire project..."
          ./gradlew build

          # 2. Publica somente os m√≥dulos que mudaram, apenas em push na branch master
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "Starting publication process for changed modules..."
          
            # Condi√ß√µes para publicar cada m√≥dulo
            if [[ "${{ steps.changed_modules.outputs.maps_any_changed }}" == "true" ]]; then
              echo "Publishing 'maps' module..."
              ./gradlew :maps:publish
            fi

            if [[ "${{ steps.changed_modules.outputs.message_any_changed }}" == "true" ]]; then
              echo "Publishing 'message' module..."
              ./gradlew :message:publish
            fi

            if [[ "${{ steps.changed_modules.outputs.payment_any_changed }}" == "true" ]]; then
              echo "Publishing 'payment' module..."
              ./gradlew :payment:publish
            fi

            if [[ "${{ steps.changed_modules.outputs.authentication_any_changed }}" == "true" ]]; then
              echo "Publishing 'authentication' module..."
              ./gradlew :authentication:publish
            fi
          else
            echo "Skipping publication: not a push to master branch."
          fi

      - name: ‚¨ÜÔ∏è Upload AARs as Artifacts
        # Condi√ß√£o para rodar somente se alguma mudan√ßa foi detectada, evitando uploads desnecess√°rios
        if: steps.changed_modules.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4 # Vers√£o atualizada
        with:
          name: release-aars
          path: |
            ./maps/build/outputs/aar/maps-release.aar
            ./message/build/outputs/aar/message-release.aar
            ./payment/build/outputs/aar/payment-release.aar
            ./authentication/build/outputs/aar/authentication-release.aar

      # =================================================================
      # PASSOS PARA TAG E RELEASE (EXECUTADOS APENAS SE HOUVER MUDAN√áAS)
      # =================================================================
      - name: ‚úçÔ∏è Create Git Tag and Release
        # Condi√ß√£o complexa para garantir que s√≥ rode em push na master e se houver mudan√ßas
        if: github.event_name == 'push' && github.ref == 'refs/heads/master' && steps.changed_modules.outputs.any_changed == 'true'
        env:
          # O comando 'gh release create' usa a vari√°vel GH_TOKEN por padr√£o
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configura o Git com um usu√°rio bot
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Define o nome da tag usando o n√∫mero da execu√ß√£o do workflow
          TAG_NAME="v0.0.${{ github.run_number }}"
          
          # Cria e empurra a tag para o reposit√≥rio
          echo "Creating and pushing tag: $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          
          # Cria o Release no GitHub usando a CLI 'gh'
          echo "Creating GitHub Release..."
          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --notes "Release autom√°tico. Mudan√ßas detectadas em: ${{ steps.changed_modules.outputs.all_changed_files }}." \
            ./maps/build/outputs/aar/maps-release.aar \
            ./message/build/outputs/aar/message-release.aar \
            ./payment/build/outputs/aar/payment-release.aar \
            ./authentication/build/outputs/aar/authentication-release.aar